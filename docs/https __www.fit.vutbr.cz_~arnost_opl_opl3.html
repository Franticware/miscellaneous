<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 3.0//EN//">
<HTML VERSION="3">
<HEAD>
  <TITLE>OPL3 Programmer's Guide</TITLE>
  <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-2">
  <META NAME="Author" CONTENT="Vladimir Arnost">
  <META NAME="Description" CONTENT="OPL3 FM Synthesiser Description">
</HEAD>
<BODY TEXT="#000000" BGCOLOR="#FFFFFF" LINK="#0000FF" VLINK="#0000FF" ALINK="0000FF">
<H1 align="center">
Programmer's Guide to Yamaha YMF 262/OPL3 FM Music Synthesizer
</H1>

<P align="center">
<BR>
HTML Version 1.12 Last Updated Nov-23-2000<BR>
(based on plaintext Version 1.00 Nov-24-1994)
<BR>
Written by Vladimir Arnost, QA-Software<BR>
e-mail:  <A HREF="mailto:arnost@dcse.fee.vutbr.cz">arnost@dcse.fee.vutbr.cz</A>
<BR>
<BR>
<BR>
<EM>This manual can be distributed freely if not modified.</EM><BR>
</P>


<HR>
<H2>
Disclaimer
</H2>
<BLOCKQUOTE>
I assume no responsibility for any damages arising out of
use or inability to use this text. No warranty is provided
about correctness of any information in this file. You are
on your own.<BR>
</BLOCKQUOTE>


<HR>
<H2>
Table of Contents
</H2>
<UL>
<LI><A HREF="#chapter1">Introduction</A>
<BR>
<LI><A HREF="#chapter2">Description of the Synthesizer</A>
  <UL>
  <LI><A HREF="#chapter2-1">Some basic facts</A>
  <LI><A HREF="#chapter2-2">Synthesis modes</A>
  </UL>
<BR>
<LI><A HREF="#chapter3">Programming the Synthesizer</A>
<LI><A HREF="#chapter4">Register Map</A>
  <UL>
  <LI><A HREF="#chapter4-1">Examples</A>
  </UL>
<BR>
<LI><A HREF="#chapter5">OPL3 Register Reference</A>
  <UL>
  <LI><A HREF="#chapter5-1">Status Register</A>
  <LI><A HREF="#chapter5-2">Data Registers</A>
    <UL>
    <LI><A HREF="#reg01">01</A>: Test Register / Waveform Select Enable
    <LI><A HREF="#reg02">02</A>: Timer 1 Count
    <LI><A HREF="#reg03">03</A>: Timer 2 Count
    <LI><A HREF="#reg004">004</A>: IRQ-Reset / Mask / Start
    <LI><A HREF="#reg104">104</A>: Four-Operator Enable
    <LI><A HREF="#reg105">105</A>: OPL3 Mode Enable
    <LI><A HREF="#reg08">08</A>: CSW / NOTE-SEL
    <LI><A HREF="#reg20">20-35</A>: Tremolo / Vibrato / Sustain / KSR /
Frequency Multiplication Factor
    <LI><A HREF="#reg40">40-55</A>: Key Scale Level / Output Level
    <LI><A HREF="#reg60">60-75</A>: Attack Rate / Decay Rate
    <LI><A HREF="#reg80">80-95</A>: Sustain Level / Release Rate
    <LI><A HREF="#regA0">A0-A8</A>: Frequency Number
    <LI><A HREF="#regB0">B0-B8</A>: Key On / Block Number / F-Number(hi bits)
    <LI><A HREF="#regBD">BD</A>: Tremolo Depth / Vibrato Depth /
Percussion Mode / BD/SD/TT/CY/HH On
    <LI><A HREF="#regC0">C0-C8</A>: FeedBack Modulation Factor / Synthesis Type
    <LI><A HREF="#regE0">E0-F5</A>: Waveform Select
    </UL>
  </UL>
<BR>
<LI><A HREF="#appendixes">Appendixes</A>
  <UL>
  <LI><A HREF="#appendixA">Examples</A>
  <LI><A HREF="#appendixB">Detection Methods</A>
  </UL>
<BR>
<LI><A HREF="#references">References</A>
</UL>


<HR>
<A NAME="chapter1"></A>
<H2>
1. Introduction
</H2>
<P>
The chip I am going to describe is getting more and more common, but
programming information is still scarce, so I have decided to fill in this
gap. All information contained in this file is a result of my experience in
Adlib programming, research (read: reverse engineering) and finally of my
effort to write down everything necessary to understand and use this piece
of hardware. No official sources (i.e. development kits, books about this
topic, etc.) were available to me except:
<P>

<UL>
<LI><A HREF="adlibdoc.arj">Adlib Programming Guide</A> - by Tero Totto, and
<LI><A HREF="#pcgpe">The PC Games Programmers Encyclopedia V1.0</A>
</UL>

The information below is a combination of known features of Adlib (alias
Yamaha YM 3812/OPL2) and my own uncountable experiments and failures, which
brought out a lot of important details you have to know about the chip.
<P>
As far as I know, there are four major sound cards based on OPL3 chip:
<P>

<UL>
<LI>Sound Blaster Pro II (not Sound Blaster Pro I) and many clones
<LI>Sound Blaster 16 and AWE32
<LI>Adlib Gold
<LI>Pro Audio Spectrum Plus/16
</UL>

I currently have a Sound Blaster Pro II-compatible card only, so all the
programming info I provide will be based on this card. (The other cards
are quite similar, however. They are just wired at different I/O-port
addresses.)
</P>

<P><BLOCKQUOTE>
<B>Note:</B>
      I assume some knowledge of FM music programming (mainly Adlib FM
      synthesizer) in this manual. If you are new to this topic I recommend
      you try Adlib first before going higher. Anyway, OPL3 is a direct
      descendant of OPL2 (what a surprise), so most features of OPL2 are
      also present on OPL3.
</BLOCKQUOTE>
</P>


<HR>
<A NAME="chapter2"></A>
<H2>
2. Description of the Synthesizer
</H2>
<A NAME="chapter2-1"></A>
<H3>
2.1 Some basic facts
</H3>
<P>
My card's user manual says: 
<CITE>"[this card contains] ... a stereo music FM synthesizer with 20
channels consisting of four (4) operators each ... "</CITE>.
I thought: <CITE>"Wow -- that's together eighty operators. This must be a
GOOD sound-card."</CITE>
I was wrong. Just another advertising lie.
<P>
So let's clear some facts. First, OPL3 has only thirty-six (36) operators
which can be combined in several ways:<BR>

<UL>
<LI>18 FM channels (36 operators), or
<LI>15 FM channels (30 ops) and 5 percussion instruments (6 ops),
    giving us 20 channels altogether, or
<LI>up to 6 four-operator FM channels (max 24 ops), the rest again being
    divided into two-operator FM channels and drums.
</UL>

From the table above you can see that not all channels can be used in four-
operator (4-OP) mode -- only a part of the synthesizer is really capable of
making 4-OP sounds -- the rest uses traditional two-operator (2-OP)
mode.<BR>
<BR>
Second, the manual states this card is capable of "stereo" music. Yes, the
quotes are necessary, because the stereo capabilities are very limited.
You are given ability to control output going to left or right channel by
turning it on and off. That's all. So the sound can flow from very left side,
center and very right side. No sound panning, no special stereo effects. 
:-( <BR>
<BR>
Well, flaming apart, back to the main topic.<BR>
</P>

<P>
<A NAME="chapter2-2"></A>
<H3>
2.2 Synthesis modes
</H3>
The OPL3 chip is capable of making sounds in several ways:<BR>

<OL>
<LI><H4>Two-operator Additive Synthesis</H4>

   Output of both operators is simply added. It is the simplest way to
   make any sound, and it works on both OPL2 and OPL3. The diagram
   should make it clear.<BR>
</P>
<PRE>
	+------------+
	|            |
	| Operator 1 +--------+
	|            |        |
	+------------+        |
			      +--------> Output
	+------------+        |
	|            |        |
	| Operator 2 +--------+
	|            |
	+------------+
</PRE>

<P>
<LI><H4>Two-operator Frequency Modulation (FM) Synthesis</H4>

   Output from the first operator (Modulator) is sent to the input of the
   second one (Carrier) and is used to modulate (alter) frequency of the
   second operator. Only the second operator produces sound. Most of
   interesting sounds are made this way. This also works on OPL2.
   Hope the picture helps.
</P>
<PRE>
	+------------+         +------------+
	|            |         |            |
	| Operator 1 +-------->| Operator 2 +--------> Output
	|(Modulator) |         | (Carrier)  |
	+------------+         +------------+
</PRE>
<P>

<LI><H4>Four-operator "Mess" Modulation Synthesis</H4>

   All of OPL3's 4-OP configurations are combinations of the above two modes
   of synthesis. OPL3 combines these two modes in four ways. I have no words
   to describe these four ways. Only the pictures can show their principle.
<P>
  <OL>
  <LI><H5>FM-FM Mode</H5>
<PRE>
	+-------+      +-------+      +-------+      +-------+
	|       |      |       |      |       |      |       |
	| Op. 1 +----->| Op. 2 +----->| Op. 3 +----->| Op. 4 +-----> Output
	|       |      |       |      |       |      |       |
	+-------+      +-------+      +-------+      +-------+
</PRE>
<P>

  <LI><H5>AM-FM Mode</H5>
</P>
<PRE>
	+-------+
	|       |
	| Op. 1 +-----------------------------------+
	|       |                                   |
	+-------+                                   |
						    |
	+-------+      +-------+      +-------+     |
	|       |      |       |      |       |     |
	| Op. 2 +----->| Op. 3 +----->| Op. 4 +-----+-----> Output
	|       |      |       |      |       |
	+-------+      +-------+      +-------+
</PRE>
<P>

  <LI><H5>FM-AM Mode</H5>
</P>
<PRE>
	+-------+      +-------+
	|       |      |       |
	| Op. 1 +----->| Op. 2 +-----+
	|       |      |       |     |
	+-------+      +-------+     |
				     +-----> Output
	+-------+      +-------+     |
	|       |      |       |     |
	| Op. 3 +----->| Op. 4 +-----+
	|       |      |       |
	+-------+      +-------+
</PRE>
<P>

  <LI><H5>AM-AM Mode</H5>
</P>
<PRE>
	+-------+
	|       |
	| Op. 1 +--------------------+
	|       |                    |
	+-------+                    |
				     |
	+-------+      +-------+     |
	|       |      |       |     |
	| Op. 2 +----->| Op. 3 +-----+-----> Output
	|       |      |       |     |
	+-------+      +-------+     |
				     |
	+-------+                    |
	|       |                    |
	| Op. 4 +--------------------+
	|       |
	+-------+
</PRE>
  </OL>

<P>
   Nice, aren't they?<BR>
<BR>
   The only way I think this can be written is a math formula.
   Symbol + (plus) means additive synthesis, and * (asterisk) means
   frequency modulation (<SAMP>Op1 * Op2</SAMP> means operator 1 modulates
   operator 2, not vice versa). Here they are:<BR>
<P>
<TABLE BORDER=0>
<TR><TD><OL>
<LI>FM-FM Mode: 
<LI>AM-FM Mode: 
<LI>FM-AM Mode: 
<LI>AM-AM Mode: 
</OL></TD>
<TD>
<SAMP>(Op1 * Op2 * Op3 * Op4) ----> Output</SAMP><BR>
<SAMP>Op1 + (Op2 * Op3 * Op4) ----> Output</SAMP><BR>
<SAMP>(Op1 * Op2) + (Op3 * Op4) --> Output</SAMP><BR>
<SAMP>Op1 + (Op2 * Op3) + Op4 ----> Output</SAMP><BR>
</TD></TR>
</TABLE>
<BR>

<BLOCKQUOTE>
<B>Note 1:</B>
   Actually, modes FM-AM and AM-AM are redundant, because they can be
   replaced by any pair of 2-OP channels operating at the same frequency.<BR>
   In FM-AM mode, the operator assignment would be straightforward:
   (Op1, Op2) and (Op3, Op4), both running in FM mode.<BR>
   In the case of AM-AM Mode, a small rearrangement of operators would be 
   necessary: (Op1, Op4) in AM mode and (Op2, Op3) in FM mode.<BR>
<BR>
<B>Note 2:</B>
   This document uses <B>AM</B> as a shorthand form of <EM>Additive Synthesis</EM>.
   Actually this is not any kind of modulation, just a simple addition of two
   signals. The AM shorthand was chosen as an <EM>"obvious"</EM> opposite of FM
   (as seen on your radio receiver). Please note that the OPL2/3 chips are
   unable to automatically perform any kind Amplitude Modulation other than
   tremolo effect.<BR>
</BLOCKQUOTE>
</P>

<LI><H4>Percussion Mode</H4>
<P>
   In this mode 6 operators are used to produce five different percussion
   instruments:
</P>
<UL>
<LI>Bass Drum (2 operators)
<LI>Snare Drum (1 operator)
<LI>Tom-Tom (1 operator)
<LI>Cymbal (1 operator)
<LI>Hi-Hat (1 operator)
</UL>
<P>
   Because these instruments occupy only three melodic channels, only
   Bass Drum, Snare Drum and Tom-Tom frequencies can be set. Cymbal and
   Hi-Hat frequencies are fixed.
<P>
   This mode is identical with that of OPL2. For more details see ADLIB.DOC.
</OL>
</P>


<HR>
<A NAME="chapter3"></A>
<H2>
3. Programming the Synthesizer
</H2>

<P>
OPL3 may be found at the following addresses:
</P>

<UL><TABLE BORDER=1>
<TR ALIGN=CENTER>
<TD COLSPAN="2">
<DD><B><FONT SIZE=+1>OPL3 Base Port Assignment</FONT></B></DD>
</TD>
</TR>

<TR ALIGN=LEFT>
<TD ALIGN=CENTER>220h or 240h (selectable)<BR>and 388h</TD>
<TD ALIGN=LEFT>Sound Blaster Pro II, 16, 32, AWE32/64 and Live,<BR>
ESS 688, etc.</TD>
</TR>

<TR ALIGN=LEFT>
<TD ALIGN=CENTER>388h</TD>
<TD ALIGN=LEFT>Adlib Gold, Windows Sound System</TD>
</TR>

<TR ALIGN=LEFT>
<TD ALIGN=CENTER>388h ?</TD>
<TD ALIGN=LEFT>Pro Audio Spectrum Plus/16<BR>
(could anyone provide some more info?)</TD>
</TR>
</TABLE></UL>

<P>
The base address of the synthesizer will be called "base".
<P>
The chip occupies four I/O addresses:
</P>

<UL><TABLE BORDER=1>
<TR>
<TD><TT>base+0 </TT></TD>
<TD>Primary index register (write), Status register (read)</TD>
</TR>

<TR>
<TD><TT>base+1</TT></TD>
<TD>Primary data register (write-only)</TD>
</TR>

<TR>
<TD><TT>base+2</TT></TD>
<TD>Secondary index register (write)</TD>
</TR>

<TR>
<TD><TT>base+3</TT></TD>
<TD>Secondary data register (write-only)</TD>
</TR>
</TABLE></UL>

<P>
The index registers are used to select internal registers and data registers
are used to write to them. Status register returns the state of two timers
built in the chip.
OPL3 contains two sets of registers. The Primary set maps to channels 0-8
(operators 0-17) and the secondary maps to channels 9-17 (operators 18-35).
The reason for this is simple: all these registers wouldn't fit into single
register set.
<P>
Unlike Adlib (OPL2), OPL3 doesn't need delay between register writes.
With OPL2 you had to wait 3.3 us after index register write and another
23 us after data register write. On the contrary OPL3 doesn't need
(almost) any delay after index register write and only 0.28 us after data
register write. This means you can neglect the delays and considerably 
speed up your music driver. But using reasonable delays will certainly do
no harm.
<P>
The data registers can't be read (they are write-only) on both OPL2 and OPL3.
</P>


<HR>
<A NAME="chapter4"></A>
<H2>
4. Register Map
</H2>

<P>
The registers are grouped in the same manner as in the OPL2 chip. Programs
using both OPL2 and OPL3 chips may use the same code provided that their
direct I/O interface is well written. The only thing you have to change is
operator-to-register mapping, which must accomodate the fact that registers
are spread between two register sets.
<P>
(The register map is nearly the same so I dared to copy it from ADLIB.DOC.)
<P>
<A HREF="#chapter5-1">Status Register</A> (base+0):
</P>

<TABLE BORDER=1>
<TR ALIGN=CENTER BGCOLOR="#CCCCCC">
<TH WIDTH="80" HEIGHT="32">D7</TH>
<TH WIDTH="80">D6</TH>
<TH WIDTH="80">D5</TH>
<TH WIDTH="80">D4</TH>
<TH WIDTH="80">D3</TH>
<TH WIDTH="80">D2</TH>
<TH WIDTH="80">D1</TH>
<TH WIDTH="80">D0</TH>
</TR>

<TR ALIGN=CENTER>
<TD>IRQFlag</TD>
<TD>T1Flag</TD>
<TD>T2Flag</TD>
</TR>
</TABLE>

<P>Empty fields are considered reserved and should not be used or relied
upon their value.</P>

<BR>
<P>
<A HREF="#chapter5-2">Data Registers</A> (base+1, base+3):
</P>

<TABLE BORDER=1>
<TR ALIGN=CENTER BGCOLOR="#CCCCCC">
<TH WIDTH="80" HEIGHT="32">Register</TH>
<TH WIDTH="80">D7</TH>
<TH WIDTH="80">D6</TH>
<TH WIDTH="80">D5</TH>
<TH WIDTH="80">D4</TH>
<TH WIDTH="80">D3</TH>
<TH WIDTH="80">D2</TH>
<TH WIDTH="80">D1</TH>
<TH WIDTH="80">D0</TH>
</TR>

<TR ALIGN=CENTER>
<TD>01</TD>
<TD COLSPAN="2"></TD>
<TD>WSEnable</TD>
<TD COLSPAN="5">Test Register</TD>
</TR>

<TR ALIGN=CENTER>
<TD>02</TD>
<TD COLSPAN="8">Timer 1 Count (80 usec resolution)</TD>
</TR>

<TR ALIGN=CENTER>
<TD>03</TD>
<TD COLSPAN="8">Timer 2 Count (320 usec resolution)</TD>
</TR>

<TR ALIGN=CENTER>
<TD>04*</TD>
<TD>IRQReset</TD>
<TD>T1 Mask</TD>
<TD>T2 Mask</TD>
<TD COLSPAN="3"></TD>
<TD>T2 Start</TD>
<TD>T1 Start</TD>
</TR>

<TR ALIGN=CENTER>
<TD>04**</TD>
<TD COLSPAN="2"></TD>
<TD>4-OP B-E</TD>
<TD>4-OP A-D</TD>
<TD>4-OP 9-C</TD>
<TD>4-OP 2-5</TD>
<TD>4-OP 1-4</TD>
<TD>4-OP 0-3</TD>
</TR>

<TR ALIGN=CENTER>
<TD>05**</TD>
<TD COLSPAN="7"></TD>
<TD>OPL3</TD>
</TR>

<TR ALIGN=CENTER>
<TD>08</TD>
<TD>CSW</TD>
<TD>Note-Sel</TD>
<TD COLSPAN="6"></TD>
</TR>

<TR ALIGN=CENTER>
<TD>20-35</TD>
<TD>Tremolo</TD>
<TD>Vibrato</TD>
<TD>Sustain</TD>
<TD>KSR</TD>
<TD COLSPAN="4">Frequency Multiplication Factor</TD>
</TR>

<TR ALIGN=CENTER>
<TD>40-55</TD>
<TD COLSPAN="2">Key Scale Level</TD>
<TD COLSPAN="6">Output Level (Attenuation)</TD>
</TR>

<TR ALIGN=CENTER>
<TD>60-75</TD>
<TD COLSPAN="4">Attack Rate</TD>
<TD COLSPAN="4">Decay Rate</TD>
</TR>

<TR ALIGN=CENTER>
<TD>80-95</TD>
<TD COLSPAN="4">Sustain Level</TD>
<TD COLSPAN="4">Release Rate</TD>
</TR>

<TR ALIGN=CENTER>
<TD>A0-A8</TD>
<TD COLSPAN="8">Frequency Number (Lower 8 bits)</TD>
</TR>

<TR ALIGN=CENTER>
<TD>B0-B8</TD>
<TD COLSPAN="2"></TD>
<TD>Key-On</TD>
<TD COLSPAN="3">Block Number</TD>
<TD COLSPAN="2">F-Number (high bits)</TD>
</TR>

<TR ALIGN=CENTER>
<TD>BD</TD>
<TD>Trem Dep</TD>
<TD>Vibr Dep</TD>
<TD>PercMode</TD>
<TD>BD On</TD>
<TD>SD On</TD>
<TD>TT On</TD>
<TD>CY On</TD>
<TD>HH On</TD>
</TR>

<TR ALIGN=CENTER>
<TD>C0-C8</TD>
<TD COLSPAN="2"></TD>
<TD>Right</TD>
<TD>Left</TD>
<TD COLSPAN="3">FeedBack Modulation Factor</TD>
<TD>SynthType</TD>
</TR>

<TR ALIGN=CENTER>
<TD>E0-F5</TD>
<TD COLSPAN="5"></TD>
<TD COLSPAN="3">Waveform Select</TD>
</TR>
</TABLE>

<P>

<TABLE BORDER=0>
<TR><TD>Notes:</TD><TD></TD></TR>
<TR><TD>&nbsp;* </TD><TD>This register exists only at port base+1</TD></TR>
<TR><TD>&nbsp;**</TD><TD>This register exists only at port base+3</TD></TR>
</TABLE>
<BR>

<P>
For register bases
<A HREF="#regA0">A0</A>,
<A HREF="#regB0">B0</A> and
<A HREF="#regC0">C0</A>
there is one register per output channel.
The primary register set holds the first nine channels (0-8) and the secondary
holds last nine channels (9-17).
<P>
For bases 
<A HREF="#reg20">20</A>,
<A HREF="#reg40">40</A>,
<A HREF="#reg60">60</A>,
<A HREF="#reg80">80</A> and
<A HREF="#regE0">E0</A>
there are two registers per channel. Each
register maps to one operator. Unfortunately the operator's register numbers
are not continuous. The following table shows which operator maps to which
register set and offset (in hex).
</P>

<TABLE BORDER=1>
<TR ALIGN=CENTER BGCOLOR="#CCCCCC">
<TH WIDTH="80" HEIGHT="32">Op.</TH>
<TH WIDTH="120">Set/Offset</TH>
<TH WIDTH="80">Op.</TH>
<TH WIDTH="120">Set/Offset</TH>
</TR>
<TR ALIGN=CENTER><TD> 0</TD><TD>0/00</TD><TD>18</TD><TD>1/00</TD></TR>
<TR ALIGN=CENTER><TD> 1</TD><TD>0/01</TD><TD>19</TD><TD>1/01</TD></TR>
<TR ALIGN=CENTER><TD> 2</TD><TD>0/02</TD><TD>20</TD><TD>1/02</TD></TR>
<TR ALIGN=CENTER><TD> 3</TD><TD>0/03</TD><TD>21</TD><TD>1/03</TD></TR>
<TR ALIGN=CENTER><TD> 4</TD><TD>0/04</TD><TD>22</TD><TD>1/04</TD></TR>
<TR ALIGN=CENTER><TD> 5</TD><TD>0/05</TD><TD>23</TD><TD>1/05</TD></TR>
<TR ALIGN=CENTER><TD> 6</TD><TD>0/08</TD><TD>24</TD><TD>1/08</TD></TR>
<TR ALIGN=CENTER><TD> 7</TD><TD>0/09</TD><TD>25</TD><TD>1/09</TD></TR>
<TR ALIGN=CENTER><TD> 8</TD><TD>0/0A</TD><TD>26</TD><TD>1/0A</TD></TR>
<TR ALIGN=CENTER><TD> 9</TD><TD>0/0B</TD><TD>27</TD><TD>1/0B</TD></TR>
<TR ALIGN=CENTER><TD>10</TD><TD>0/0C</TD><TD>28</TD><TD>1/0C</TD></TR>
<TR ALIGN=CENTER><TD>11</TD><TD>0/0D</TD><TD>29</TD><TD>1/0D</TD></TR>
<TR ALIGN=CENTER><TD>12</TD><TD>0/10</TD><TD>30</TD><TD>1/10</TD></TR>
<TR ALIGN=CENTER><TD>13</TD><TD>0/11</TD><TD>31</TD><TD>1/11</TD></TR>
<TR ALIGN=CENTER><TD>14</TD><TD>0/12</TD><TD>32</TD><TD>1/12</TD></TR>
<TR ALIGN=CENTER><TD>15</TD><TD>0/13</TD><TD>33</TD><TD>1/13</TD></TR>
<TR ALIGN=CENTER><TD>16</TD><TD>0/14</TD><TD>34</TD><TD>1/14</TD></TR>
<TR ALIGN=CENTER><TD>17</TD><TD>0/15</TD><TD>35</TD><TD>1/15</TD></TR>
</TABLE>

<P>
The following tables summarize which operators form a channel in various modes:
<P>
<H4>1. Two-operator Melodic Mode</H4>
<PRE>
+------------+--------------------------------------------------------------+
| Channel    | 0  1  2  3  4  5  6  7  8  9  10  11  12  13  14  15  16  17 |
+------------+--------------------------------------------------------------+
| Operator 1 | 0  1  2  6  7  8  12 13 14 18 19  20  24  25  26  30  31  32 |
| Operator 2 | 3  4  5  9  10 11 15 16 17 21 22  23  27  28  29  33  34  35 |
+------------+--------------------------------------------------------------+
</PRE>
<H4>2. Two-operator Melodic and Percussion Mode</H4>
<PRE>
+------------+--------------------------------------------------------------+
| Channel    | 0  1  2  3  4  5  BD SD TT CY HH  9  10 11 12 13 14 15 16 17 |
+------------+--------------------------------------------------------------+
| Operator 1 | 0  1  2  6  7  8  12 16 14 17 13  18 19 20 24 25 26 30 31 32 |
| Operator 2 | 3  4  5  9  10 11 15              21 22 23 27 28 29 33 34 35 |
+------------+--------------------------------------------------------------+
</PRE>
<H4>3. Four-operator Melodic Mode</H4>
<PRE>
+------------+---------------------------------------------------+
| Channel    | 0   1   2    6   7   8    9   10  11   15  16  17 |
+------------+---------------------------------------------------+
| Operator 1 | 0   1   2    12  13  14   18  19  20   30  31  32 |
| Operator 2 | 3   4   5    15  16  17   21  22  23   33  34  35 |
| Operator 3 | 6   7   8                 24  25  26              |
| Operator 4 | 9   10  11                27  28  29              |
+------------+---------------------------------------------------+
</PRE>
<P>
   Channels 3, 4, 5 and 12, 13, 14 can't be used separately because their
   operators became part of channels 0, 1, 2 and 9, 10, 11 respectively.
   For instance a four-operator channel 1 consists of two two-operator
   channels number 1 and 4. (The second 2-OP channel number is always the
   first 2-OP channel number plus three.)
<P>
   OPL3 allows you to enable/disable 4-OP mode separately for any of
   channels 0, 1, 2, 9, 10 and 11 (see register
   <A HREF="#reg104">104h</A> in the reference below).
   This means for instance when you switch only channel 2 into 4-OP mode,
   channels number 0, 1, 3, 4, 6, 7, 8, 9, etc. will be still independent
   2-OP channels.
<P>
   Channels 6, 7, 8 and 15, 16, 17 are always two-operator ones. They can't
   be grouped to form four-operator channels.
<P>
<H4>4. Four-operator Melodic and Percussion Mode</H4>
<PRE>
+------------+--------------------------------------------------------+
| Channel    | 0   1   2    BD SD TT CY HH    9   10  11   15  16  17 |
+------------+--------------------------------------------------------+
| Operator 1 | 0   1   2    12 16 14 17 13    18  19  20   30  31  32 |
| Operator 2 | 3   4   5    15                21  22  23   33  34  35 |
| Operator 3 | 6   7   8                      24  25  26              |
| Operator 4 | 9   10  11                     27  28  29              |
+------------+--------------------------------------------------------+
</PRE>

<P>
<A NAME="chapter4-1"></A>
<H3>Examples</H3>
<UL>
<LI> Two-operator channel #14 consists of operators 26 and 29 which occupy
     these registers (all are in the secondary register set):
<PRE>
	12A - Operator 1 - Tremolo/Vibrato/Sustain/KSR/Multiplication
	12D - Operator 2 - Tremolo/Vibrato/Sustain/KSR/Multiplication
	14A - Operator 1 - Key Scale Level/Output Level
	14D - Operator 2 - Key Scale Level/Output Level
	16A - Operator 1 - Attack Rate/Decay Rate
	16D - Operator 2 - Attack Rate/Decay Rate
	18A - Operator 1 - Sustain Level/Release Rate
	18D - Operator 2 - Sustain Level/Release Rate
	1A5 -              Frequency Number (low)
	1B5 -              Key On/Block Number/Frequency Number (high)
	1C5 -              FeedBack/Synthesis Type
	1EA - Operator 1 - Waveform Select
	1ED - Operator 2 - Waveform Select
</PRE>
<LI> Four-operator channel #1 consists of operators 1, 4, 7 and 10. All
     registers except register 104h are in the primary set:
<PRE>
	104 - bit 1 = 1  - Enable Four-Operator Synthesis in channel #1
	 21 - Operator 1 - Tremolo/Vibrato/Sustain/KSR/Multiplication
	 24 - Operator 2 - Tremolo/Vibrato/Sustain/KSR/Multiplication
	 29 - Operator 3 - Tremolo/Vibrato/Sustain/KSR/Multiplication
	 2C - Operator 4 - Tremolo/Vibrato/Sustain/KSR/Multiplication
	 41 - Operator 1 - Key Scale Level/Output Level
	 44 - Operator 2 - Key Scale Level/Output Level
	 49 - Operator 3 - Key Scale Level/Output Level
	 4C - Operator 4 - Key Scale Level/Output Level
	 61 - Operator 1 - Attack Rate/Decay Rate
	 64 - Operator 2 - Attack Rate/Decay Rate
	 69 - Operator 3 - Attack Rate/Decay Rate
	 6C - Operator 4 - Attack Rate/Decay Rate
	 81 - Operator 1 - Sustain Level/Release Rate
	 84 - Operator 2 - Sustain Level/Release Rate
	 89 - Operator 3 - Sustain Level/Release Rate
	 8C - Operator 4 - Sustain Level/Release Rate
	 A1 -              Frequency Number (low)
	 A4 -              Unused
	 B1 -              Key On/Block Number/Frequency Number (high)
	 B4 -              Unused
	 C1 -              FeedBack/Synthesis Type (part 1)
	 C4 -              Synthesis Type (part 2)
	 E1 - Operator 1 - Waveform Select
	 E4 - Operator 2 - Waveform Select
	 E9 - Operator 3 - Waveform Select
	 EC - Operator 4 - Waveform Select
</PRE>
</UL>
<P>
<BLOCKQUOTE>
<B>Note:</B>
	  If a register number is greater than 100h, then it belongs into the
    	  secondary register set. (I use this numbering to emphasize the fact
    	  that the particular register MUST be written to the secondary set.)
          See <A HREF="#appendixA">Appendix A</A>.
</BLOCKQUOTE>
</P>


<HR>
<A NAME="chapter5"></A>
<H2>
5. OPL3 Register Reference
</H2>

<P>
Because the registers of OPL3 are almost the same as of OPL2, I have copied
their descriptions from file ADLIB.DOC.
<P>
<A NAME="chapter5-1"></A>
<H3>5.1 Status Register:</H3>
<PRE>
   +-7-+-6-+-5-+-4-+-3-+-2-+-1-+-0-+
   |IRQ|T1 |T2 |     Not used      |
   +---+---+---+---+---+---+---+---+
</PRE>
   bit 7: IRQ Flag. Set whenever any timer has elapsed.<BR>
   bit 6: Timer 1 Flag. Set every time the preset time in Timer 1 has
elapsed.<BR>
   bit 5: Timer 2 Flag. Set every time the preset time in Timer 2 has
elapsed.<BR>
<P>
   Timer interrupts are not wired to any IRQ (why??). The timers can be used
   to detect the OPL2/OPL3 chip (see <A HREF="#appendixB">Appendix B</A>).
<P>

<A NAME="chapter5-2"></A>
<H3>5.2 Data Registers:</H3>
<P>
<A NAME="reg01"></A>
<H4>01: Test Register / Waveform Select Enable:</H4>
<PRE>
   +-7-+-6-+-5-+-4-+-3-+-2-+-1-+-0-+
   |       |WSE|   Test Register   |
   +---+---+---+---+---+---+---+---+
</PRE>
   bit 5:    Waveform Select Enable. If clear, all channels will use normal
	     sine wave. If set, register <A HREF="#regE0">E0-F5</A>
             (Waveform Select) contents will be used.<BR>
   bits 0-4: Test Register. Must be reset to zero before any operation.
<P>

<A NAME="reg02"></A>
<H4>02: Timer 1 Count:</H4>
<P>
   Upward 8 bit counter with a resolution of 80 usec. If an overflow occurs,
   the status register bit is set, and the preset value is loaded into the
   timer again.
<P>

<A NAME="reg03"></A>
<H4>03: Timer 2 Count:</H4>
<P>
   Same as Timer 1, but with a resolution of 320 usec.
<P>

<A NAME="reg004"></A>
<H4>004 (port: base+1): IRQ-Reset / Mask / Start:</H4>
<PRE>
   +-7-+-6-+-5-+-4-+-3-+-2-+-1-+-0-+
   |Rst|T1M|T2M|           |T2S|T1S|
   +---+---+---+---+---+---+---+---+
</PRE>
   bit 7:    IRQ-Reset. Resets timer and IRQ flags in status register.
	     All other bits are ignored when this bit is set.<BR>
   bit 6:    Timer 1 Mask. If 1, status register is not affected in
overflow.<BR>
   bit 5:    Timer 2 Mask. Same as above.<BR>
   bit 1:    Timer 2 Start. Timer on/off.<BR>
   bit 0:    Timer 1 Start. Same as above.<BR>
<P>

<A NAME="reg104"></A>
<H4>104 (port: base+3): Four-Operator Enable:</H4>
<PRE>
   +-7-+-6-+-5-+-4-+-3-+-2-+-1-+-0-+
   |       |ChB|ChA|Ch9|Ch2|Ch1|Ch0|
   +---+---+---+---+---+---+---+---+
</PRE>
   bit 5:    Enable four-operator synthesis for channel pair 11 - 14
(decimal).<BR>
   bit 4:    Same as above for channel pair 10 - 13.<BR>
   bit 3:    Same as above for channel pair 9 - 12.<BR>
   bit 2:    Same as above for channel pair 2 - 5.<BR>
   bit 1:    Same as above for channel pair 1 - 4.<BR>
   bit 0:    Same as above for channel pair 0 - 3.<BR>
<P>
   If reset to zero, OPL3 can produce 18 two-operator sounds at a
time.<BR>
   If nonzero, OPL3 produces four-operator sound in appropriate channel pair.
<P>

<A NAME="reg105"></A>
<H4>105 (port: base+3): OPL3 Mode Enable:</H4>
<PRE>
   +-7-+-6-+-5-+-4-+-3-+-2-+-1-+-0-+
   |                           |OPL|
   +---+---+---+---+---+---+---+---+
</PRE>
   bit 0:    OPL3 Mode Enable. When set, OPL3 extensions (36 operators, 4-OP
             synthesis, 8 waveforms, stereo output) can be used. When reset,
             the chip behaves as an ordinary OPL2. This bit is zero by default
             for compatibility with OPL2.
<P>

<A NAME="reg08"></A>
<H4>08: CSW / NOTE-SEL:</H4>
<PRE>
   +-7-+-6-+-5-+-4-+-3-+-2-+-1-+-0-+
   |CSW|N-S|                       |
   +---+---+---+---+---+---+---+---+
</PRE>
   bit 7:    Composite sine wave mode on/off. All KEY-ON bits must be clear
	     in order to use this mode. The card is unable to create any other
	     sound when in CSW mode. (Unfortunately, I have no info how to
	     use this mode :-< ).<BR>
   bit 6:    NOTE-SEL. Controls the split point of the keyboard. When 0, the
	     keyboard split is the second bit from the bit 8 of the F-Number.
	     When 1, the MSb of the F-Number is used. (???)<BR>
<P>

<A NAME="reg20"></A>
<H4>20-35: Tremolo / Vibrato / Sustain / KSR / Frequency Multiplication
Factor:</H4>
<PRE>
   +-7-+-6-+-5-+-4-+-3-+-2-+-1-+-0-+
   |Tre|Vib|Sus|KSR| Multiplication|
   +---+---+---+---+---+---+---+---+
</PRE>
   bit 7:    Tremolo (Amplitude vibrato) on/off.<BR>
   bit 6:    Frequency vibrato on/off.<BR>
   bit 5:    Sound Sustaining. When 1, operator's output level will be held at
             its sustain level until a KEY-OFF is done.<BR>
   bit 4:    Envelope scaling (KSR) on/off. When 1, higher notes are shorter
             than lower notes.<BR>
   bits 0-3: Frequency Multiplication Factor (MULTI). Operator's frequency
	     is set to (see registers <A HREF="#regA0">A0</A>,
             <A HREF="#regB0">B0</A>) F-Number * Factor.<BR>
<PRE>
		+-------+--------+
		| MULTI | Factor |
		+-------+--------+
		|   0   |   1/2  |
		|   1   |    1   |
		|   2   |    2   |
		|   3   |    3   |
		|   4   |    4   |
		|   5   |    5   |
		|   6   |    6   |
		|   7   |    7   |
		|   8   |    8   |
		|   9   |    9   |
		|  10   |   10   |
		|  11   |   10   |
		|  12   |   12   |
		|  13   |   12   |
		|  14   |   15   |
		|  15   |   15   |
		+-------+--------+
</PRE>

<A NAME="reg40"></A>
<H4>40-55: Key Scale Level / Output Level:</H4>
<PRE>
   +-7-+-6-+-5-+-4-+-3-+-2-+-1-+-0-+
   |  KSL  |      Output Level     |
   +---+---+---+---+---+---+---+---+
</PRE>
   bits 6-7: Key Scale Level. Attenuates output level towards higher pitch:
<PRE>
		+-----+-------------+
		| KSL | Attenuation |
		+-----+-------------+
		|  0  | -           |
		|  1  | 1.5 dB/oct  |
		|  2  | 3.0 dB/oct  |
		|  3  | 6.0 dB/oct  |
		+-----+-------------+
</PRE>
   bits 0-5: Output Level. Attenuates the operator output level. 0 is the
	     loudest, 3F is the softest. In additive synthesis, varying
	     the output level of any operator varies the volume of its
	     corresponding channel. In FM synthesis, varying the output level
	     of the carrier varies the volume of the channel. Varying the
	     output of the modulator will change the frequency spectrum
	     produced by the carrier.<BR>
<BR>
	     The following table summarizes which operators' output levels
	     should be updated when trying to change channel output level.
<PRE>
		+-------+------+------+------+------+
		| Mode  | Op 1 | Op 2 | Op 3 | Op 4 |
		+-------+------+------+------+------+
		|  AM   |  +   |  +   | N/A  | N/A  |
		|  FM   |  -   |  +   | N/A  | N/A  |
		| FM-FM |  -   |  -   |  -   |  +   |
		| AM-FM |  +   |  -   |  -   |  +   |
		| FM-AM |  -   |  +   |  -   |  +   |
		| AM-AM |  +   |  -   |  +   |  +   |
		+-------+------+------+------+------+
</PRE>

<A NAME="reg60"></A>
<H4>60-75: Attack Rate / Decay Rate:</H4>
<PRE>
   +-7-+-6-+-5-+-4-+-3-+-2-+-1-+-0-+
   |  Attack Rate  |  Decay Rate   |
   +---+---+---+---+---+---+---+---+
</PRE>
   bits 4-7: Attack Rate. Determines the rising time for the sound.
	     The higher the value, the faster the attack.<BR>
   bits 0-3: Decay Rate. Determines the diminishing time for the sound.
	     The higher the value, the shorter the decay.<BR>
<P>

<A NAME="reg80"></A>
<H4>80-95: Sustain Level / Release Rate:</H4>
<PRE>
   +-7-+-6-+-5-+-4-+-3-+-2-+-1-+-0-+
   | Sustain Level |  Release Rate |
   +---+---+---+---+---+---+---+---+
</PRE>
   bits 4-7: Sustain Level. Determines the point at which the sound ceases
	     to decay and chages to a sound having a constant level. The
	     sustain level is expressed as a fraction of the maximum level.
	     0 is the softest and F is the loudest sustain level.
	     <B>Note</B> that the Sustain-bit in the register <A HREF="#reg20">20-35</A> must
             be set for this to have an effect.<BR>
   bits 0-3: Release Rate. Determines the rate at which the sound disappears
	     after KEY-OFF. The higher the value, the shorter the release.
<P>

<A NAME="regA0"></A>
<H4>A0-A8: Frequency Number:</H4>

   Determines the pitch of the note. Highest bits of F-Number are stored
   in the register below.
<P>

<A NAME="regB0"></A>
<H4>B0-B8: Key On / Block Number / F-Number(hi bits):</H4>
<PRE>
   +-7-+-6-+-5-+-4-+-3-+-2-+-1-+-0-+
   |       |KEY| Block Num.| Freq  |
   +---+---+---+---+---+---+---+---+
</PRE>
   bit 5:    KEY-ON. When 1, channel output is enabled.<BR>
   bits 2-4: Block Number. Roughly determines the octave.<BR>
   bits 0-1: Frequency Number. 2 highest bits of the above register.<BR>
<BR>
	     The following formula is used to determine F-Number and Block:
<P align="center">
		F-Number = Music Frequency * 2^(20-Block) / 49716 Hz
<P>
 <B>Note:</B> 
         In four-operator mode only the register value of Operators 1 and 2
         is used, value of Operators 3 and 4 in this register is ignored.
         In other words: one channel uses only one frequency, block and KEY-ON
         value at a time, regardless whether it is a two- or four-operator
         channel.
<P>

<A NAME="regBD"></A>
<H4>BD: Tremolo Depth / Vibrato Depth / Percussion Mode / BD/SD/TT/CY/HH On:</H4>
<PRE>
   +-7-+-6-+-5-+-4-+-3-+-2-+-1-+-0-+
   |Tre|Vib|Per|BD |SD |TT |CY |HH |
   +---+---+---+---+---+---+---+---+
</PRE>
   bit 7:    Tremolo (Amplitude Vibrato) Depth. 0 = 1.0dB, 1 = 4.8dB.<BR>
   bit 6:    Frequency Vibrato Depth. 0 = 7 cents, 1 = 14 cents.
	     A "cent" is 1/100 of a semi-tone.<BR>
   bit 5:    Percussion Mode. 0 = Melodic Mode, 1 = Percussion Mode.<BR>
   bit 4:    BD On. KEY-ON of the Bass Drum channel.<BR>
   bit 3:    SD On. KEY-ON of the Snare Drum channel.<BR>
   bit 2:    TT On. KEY-ON of the Tom-Tom channel.<BR>
   bit 1:    CY On. KEY-ON of the Cymbal channel.<BR>
   bit 0:    HH On. KEY-ON of the Hi-Hat channel.<BR>
<BR>
   <B>Note:</B>
         KEY-ON bits of channels 6, 7 and 8 must be clear and their
	 F-Nums, Attack/Decay/Release rates, etc. must be set properly
	 to use percussion mode.
<P>

<A NAME="regC0"></A>
<H4>C0-C8: FeedBack Modulation Factor / Synthesis Type:</H4>
<PRE>
   +-7-+-6-+-5-+-4-+-3-+-2-+-1-+-0-+
   |       | R | L | FeedBack  |Syn|
   +---+---+---+---+---+---+---+---+
</PRE>
   bit 5:    Right Speaker Enable. When set, channel output goes to right
             speaker.<BR>
   bit 4:    Left Speaker Enable. When set, channel output goes to left
             speaker. At least one of these bits must be set to hear
             the channel.<BR>
	     These two bits can be used to realize sound "panning", but this
	     method offers only three pan positions (left/center/right).
	     These bits apply only to operators producing sound (Carriers).
	     Modulators are not affected by their setting.<BR>
   bits 1-3: FeedBack Modulation Factor. If 0, no feedback is present. If 1-7,
	     operator 1 will send a portion of its output back into itself.
<PRE>
		+----------+--------+
		| FeedBack | Factor |
		+----------+--------+
		|    0     |   0    |
		|    1     |  n/16  |
		|    2     |  n/8   |
		|    3     |  n/4   |
		|    4     |  n/2   |
		|    5     |   n    |
		|    6     |  2.n   |
		|    7     |  4.n   |
		+----------+--------+
</PRE>
	     When in four-operator mode, the FeedBack value is used only by
	     Operator 1, value of Operators 2, 3 and 4 is ignored.<BR>
   bit 0:    Synthesis Type. 1 = Additive synthesis, 0 = Frequency Modulation<BR>
	     In four-operator mode, there are two bits controlling the
	     synthesis type. Both are the bit 0 of register C0, one of
	     Operators 1 and 2 and the second of Operators 3 and 4.
<PRE>
		+--------+--------+--------+
		| Op 1&2 | Op 3&4 |  Type  |
		+--------+--------+--------+
		|    0   |  NONE  |   FM   |
		|    1   |  NONE  |   AM   |
		|    0   |    0   | FM-FM  |
		|    1   |    0   | AM-FM  |
		|    0   |    1   | FM-AM  |
		|    1   |    1   | AM-AM  |
		+--------+--------+--------+
</PRE>
<P>

<A NAME="regE0"></A>
<H4>E0-F5: Waveform Select:</H4>
<PRE>
   +-7-+-6-+-5-+-4-+-3-+-2-+-1-+-0-+
   |                   | WaveForm  |
   +---+---+---+---+---+---+---+---+
</PRE>
<P>
   bits 0-2: WaveForm Select (WS):

<P>
<TABLE BORDER=0>
<TR><TD>
<UL>
<LI>WaveForm 0: Sine<BR>
<IMG SRC="wave0.gif">
<BR><BR>
<LI>WaveForm 1: Half-Sine<BR>
<IMG SRC="wave1.gif">
<BR><BR>
<LI>WaveForm 2: Abs-Sine<BR>
<IMG SRC="wave2.gif">
<BR><BR>
<LI>WaveForm 3: Pulse-Sine<BR>
<IMG SRC="wave3.gif">
<BR>
</UL>
</TD>
<TD>
<UL>
<LI>WaveForm 4: Sine - even periods only<BR>
<IMG SRC="wave4.gif">
<BR><BR>
<LI>WaveForm 5: Abs-Sine - even periods only<BR>
<IMG SRC="wave5.gif">
<BR><BR>
<LI>WaveForm 6: Square<BR>
<IMG SRC="wave6.gif">
<BR><BR>
<LI>WaveForm 7: Derived Square<BR>
<IMG SRC="wave7.gif">
<BR>
</UL>
</TD></TR>
</TABLE>
</P>

<!--
<PRE>
	WaveForm 0: Sine		WaveForm 1: Half-Sine
	 | /~\	       			 | /~\         /~\
	 |/   \       /                  |/   \       /   \
	-/-----\-----/--                -+-----+-----+-----+-
	 |      \   /                    |
	 |       \_/                     |

	WaveForm 2: Abs-Sine		WaveForm 3: Pulse-Sine
	 | /~\	 /~\   			 | /~|         /~|
	 |/   \ /   \ /                  |/  |        /  |
	-+-----+-----+--                -+---+-------+---+---
	 |                               |
	 |                               |

	WaveForm 4: Sine - even periods only
	 | /~\	       		   /~\
	 |/   \                   /   \
	-+-----\-----+-----------+-----\-----+-
	 |      \   /                   \   /
	 |       \_/                     \_/

	WaveForm 5: Abs-Sine - even periods only
	 | /~\	 /~\   		   /~\   /~\
	 |/   \ /   \             /   \ /   \
	-+-----+-----+-----------+-----+-----+-
	 |
	 |

	WaveForm 6: Square
	 |-----+     +-----+     +-----+     +-
	 |     |     |     |     |     |     |
	-+-----|-----|-----|-----|-----|-----|--
	 |     |     |     |     |     |     |
	 |     +-----+     +-----+     +-----+

	WaveForm 7: Derived Square
	 |          |\                |\
	 |         |  \              |  \
	-+--__----|----~~-----__----|----~~-----
	 |    \  |              \  |
	 |     \|                \|
-->
<P>
<BLOCKQUOTE>
<B>Note:</B>
	 Bit 5 of register <A HREF="#reg01">01</A> must be set to use waveforms other than sine.
	 Waveforms 4-7 are available only on OPL3.
</BLOCKQUOTE>
</P>


<HR>
<A NAME="appendixes"></A>
<H1>
Appendixes
</H1>

<A NAME="appendixA"></A>
<H2>
Appendix A - Examples
</H2>

<P>
These examples show a few working routines used in my MUS Player.
They are written in Borland C++ 3.1 but should be easy to translate to any
other language.</P>

<PRE>
--------------------------------- cut here ---------------------------------
// I prefer using these Assembler-like types
typedef unsigned int  WORD;
typedef unsigned char BYTE;

/*
 * FM Synthesizer base port. SB Pro II - 0x220, Adlib 0x388
 */
WORD FMport = 0x220;

/*
 * Enables OPL3 extensions.
 */
WORD OPL3 = 1;

/*
 * Direct write to any Adlib/SB Pro II FM synthetiser register.
 *   reg - register number (range 0x001-0x0F5 and 0x101-0x1F5). When high byte
 *         of reg is zero, data go to port FMport, otherwise to FMport+2
 *   data - register value to be written
 */
BYTE FMwriteReg(WORD reg, BYTE data)
{
    asm {
	mov	dx,FMport
	mov	ax,reg
	or	ah,ah		// high byte is nonzero -- write to port base+2
	jz	out1
	inc	dx
	inc	dx
    }
out1: asm {
	out	dx,al
	mov	cx,6
    }
loop1:asm {			// delay between writes
	in	al,dx
	loop	loop1

	inc	dx
	mov	al,data
	out	dx,al
	dec	dx
	mov	cx,36
    }
loop2:asm {			// delay after data write
	in	al,dx
	loop	loop2
    }
    return _AL;
}

/*
 * Write to an operator pair. To be used for register bases of 0x20, 0x40,
 * 0x60, 0x80 and 0xE0.
 */
void FMwriteChannel(BYTE regbase, BYTE channel, BYTE data1, BYTE data2)
{
    static BYTE adlib_op[] = {0, 1, 2, 8, 9, 10, 16, 17, 18};
    static BYTE sbpro_op[] = { 0,  1,  2,   6,  7,  8,  12, 13, 14,
			      18, 19, 20,  24, 25, 26,  30, 31, 32};
    static WORD rg[] = {0x000,0x001,0x002,0x003,0x004,0x005,
			0x008,0x009,0x00A,0x00B,0x00C,0x00D,
			0x010,0x011,0x012,0x013,0x014,0x015,
			0x100,0x101,0x102,0x103,0x104,0x105,
			0x108,0x109,0x10A,0x10B,0x10C,0x10D,
			0x110,0x111,0x112,0x113,0x114,0x115};

    if (OPL3)
    {
	register WORD reg = sbpro_op[channel];
	FMwriteReg(rg[reg]+regbase, data1);
	FMwriteReg(rg[reg+3]+regbase, data2);
    } else {
	register WORD reg = regbase+adlib_op[channel];
	FMwriteReg(reg, data1);
	FMwriteReg(reg+3, data2);
    }
}

/*
 * Write to channel a single value. To be used for register bases of
 * 0xA0, 0xB0 and 0xC0.
 */
void FMwriteValue(BYTE regbase, BYTE channel, BYTE value)
{
    static WORD ch[] = {0x000,0x001,0x002,0x003,0x004,0x005,0x006,0x007,0x008,
			0x100,0x101,0x102,0x103,0x104,0x105,0x106,0x107,0x108};
    register WORD chan;

    if (OPL3)
	chan = ch[channel];
    else
	chan = channel;
    FMwriteReg(regbase + chan, value);
}
--------------------------------- cut here ---------------------------------
</PRE>


<A NAME="appendixB"></A>
<HR>
<H2>
Appendix B - Detection Methods
</H2>

<A NAME="detectOPL2"></A>
<H3>
OPL2 Detection
</H3>

<P>
An official method of Adlib (OPL2) detection is:
<P>
<OL>
<LI> Reset Timer 1 and Timer 2: write 60h to register 4.
<LI> Reset the IRQ: write 80h to register 4.<BR>
   <B>Note:</B> Steps 1 and 2 can't be combined together.
<LI> Read status register: read port base+0 (388h). Save the result.
<LI> Set Timer 1 to FFh: write FFh to register 2.
<LI> Unmask and start Timer 1: write 21h to register 4.
<LI> Wait in a delay loop for at least 80 usec.
<LI> Read status register: read port base+0 (388h). Save the result.
<LI> Reset Timer 1, Timer 2 and IRQ as in steps 1 and 2.
<LI> Test the results of the two reads: the first should be 0,
   the second should be C0h.
   If either is incorrect, then the OPL2 is not present.
</OL>
<P>
<B>Notes:</B>
<OL>
<LI>   You should AND the result bytes with E0h because the unused bits
       are undefined.
<LI>   This testing method doesn't work in some SoundBlaster compatible
       cards.
</OL>
<P>

<H3>
OPL3 Detection
</H3>

<OL>
<LI> <A HREF="#detectOPL2">Detect OPL2</A>. If present, continue.
<LI> Read status register: read port base+0.
<LI> AND the result with 06h.
<LI> If the result is zero, you have OPL3, otherwise OPL2.
</OL>

<B>Note:</B>
      This is NOT an official method. I have dug it out of a sound driver.
      I haven't tested it, because I haven't an OPL2 card (Adlib, SB Pro I).
      Nevertheless it "detects" my SB Pro II properly. ;-)
<P>
Another possible detection method for distinguishing between SB Pro I and
SB Pro II would be to try to detect OPL2 at I/O port base+0 and then at port
base+2. The first test should succeed and the second should fail if OPL3 is
present. (Remember: SB Pro I contains twin OPL2 chips at addresses base+0 and
base+2, while SB Pro II contains one OPL3 chip at I/O address base+0 thru
base+3).
<P>

<H3>
The BLASTER Environment Variable
</H3>

<P>
Perhaps the most recommended "detection" method. Reading this variable avoids
blindfold I/O port scanning and possible device conflicts. The user is
responsible for its proper setting.
<P>
The variable has this format:
<DD>
    BLASTER=<B>A</B><VAR>addr</VAR> <B>I</B><VAR>irq</VAR> <B>D</B><VAR>dma8</VAR>
<B>H</B><VAR>dma16</VAR> <B>P</B><VAR>midi</VAR> <B>E</B><VAR>emu</VAR> <B>T</B><VAR>type</VAR>
</DD>
<P>
<B>A</B>: Base I/O address given in hex. For most Sound Blasters the default is 220.<BR>
<B>I</B>: IRQ Number (decimal). Default 7 (old SB and SB Pro), 5 (SB 16, etc.).<BR>
<B>D</B>: DMA Number (decimal). Default 1.<BR>
<B>H</B>: High DMA Number (decimal). Default 5 (on SB 16 and newer cards only)<BR>
<B>P</B>: MPU-401 MIDI port (hexadecimal). Default 330 (on SB 16 and newer cards)<BR>
<B>E</B>: EMU-8000 base port (hexadecimal). Default 620 (on AWE32 and newer cards)<BR>
<B>T</B>: Card Type (decimal):<BR>
<DD> 1 - Sound Blaster 1.5
<DD> 2 - Sound Blaster Pro I
<DD> 3 - Sound Blaster 2.0
<DD> 4 - Sound Blaster Pro II
<DD> 6 - Sound Blaster 16/AWE 32/32/64
</DD>
<P>
Examples:
<DD>BLASTER=A220 I7 D1 T4 &nbsp;  (old 8-bit Sound Blaster Pro II)
<DD>BLASTER=A220 I5 D1 H5 P330 E620 T6 &nbsp;  (16-bit Sound Blaster 32)
</DD>
</P>


<HR>
<A NAME="references"></A>
<H2>
References
</H2>

<P>
<PRE>
<A NAME="pcgpe"></A>
<B>Title:</B>		The PC Games Programmers Encyclopedia
<B>Authors:</B>	Mark Feldman and many others on Usenet and Internet
<B>WWW:</B>		<A HREF="http://www.qzx.com/pc-gpe/">http://www.qzx.com/pc-gpe/</A>
<B>FTP:</B>		<A HREF="ftp://x2ftp.oulu.fi/pub/msdos/programming/gpe/pcgpe10.zip">ftp://x2ftp.oulu.fi/pub/msdos/programming/gpe/pcgpe10.zip</A> - 700KB
</PRE>
 ... you can find (almost) everything you need there

<PRE>
<B>Title:</B>		Sound Blaster - The Official Book
<B>Authors:</B>	Richard Heimlich, David M. Golden, Ivan Luk, Peter M. Ridge
<B>Publishers:</B>	Osborne/McGraw Hill
<B>ISBN:</B>		0-07-881907-5
</PRE>
 ... this is a number-one in my book-wishlist. If anyone wanted to get rid of
     the book, I wouldn't scorn it ... :-)

<PRE>
<B>Title:</B>		The SoundBlaster Developer Kit
<B>Publishers:</B>	Creative Labs Inc
		Creative Technology PTE LTD
</PRE>
 ... I wonder if you can find something comprehensible in that.
</P>


<HR>

<P><A HREF="index.html"><IMG SRC="/images/back.gif" ALIGN="MIDDLE" ALT="Back"></A>
&nbsp;<A HREF="index.html">Back</A> to previous page.</P>

<ADDRESS>
<P>&copy; 1996-2000 <A HREF="http://www.fee.vutbr.cz/~arnost">Vladimir Arnost</A><BR>
Last modified on <!-- begin flastmod -->
19. January 2009<!-- end --><BR>
If you have any suggestions, bug reports or ideas how to improve these
pages, please feel free to
<A HREF="mailto:arnost@dcse.fee.vutbr.cz">mail me</A>.<BR>
</ADDRESS>

</BODY>
</HTML>
